# Learning to Fly: Computational Controller Design for Hybrid UAVs with Reinforcement Learning
**Jie Xu, Tao Du, Michael Foshey, Beichen Li, Bo Zhu, Adriana Schulz, Wojciech Matusik**

**ACM Transactions on Graphics, 38(4) 42:1-42:12 (SIGGRAPH), 2019**



#### Code Structure

- `SimulationUI`: C++ rigid body simulation to visualize the controller's performance. (C++, Coming Soon)
- `Training`: Code to train the controller with our method with Reinforcement Learning. (Python)
- `Firmware`: Modified Ardupilot firmware code to implement our controller on real hardware. (C++)



#### Training

- The code has been tested on `Ubuntu 16.04`.

- The code relies on a modified version of OpenAI baselines in `git@github.com:eanswer/openai_baselines.git`. To run the code, please first clone the repository 

  ```
  git clone git@github.com:eanswer/openai_baselines.git
  ```

  and then follow the `README.md` to install baselines.

- We provide two models in the data folder.

- To start training a controller for a model, for example QuadPlane, in one thread,

  ```
  python run.py --model QuadPlane
  ```

  or in multiple threads (e.g. 4),

  ```
  mpirun -np 4 python run.py --model QuadPlane
  ```

  You can also add a `--visualize` to visualize the training by `Mujoco`. (If you don't install `Mujoco`, this option does't work).

- The trained models are saved in `results` folder.

- To test a trained mode, for example model_afterIter_400.ckpt, you can run

  ```
  python run.py --model QuadPlane --controller model_afterIter_400 --play
  ```

- To save a trained model to a `c++` format to be plugged into the `SimulationUI` code or `ardupilot` firmware code.

  ```
  python save.py --controller model_afterIter_400
  ```



#### Firmware Deployment

- The firmware code is based on the Ardupilot codebase and tested in Pixhawk 1.0.

- First plug the model description file generated by training code (should named `AP_MotorsPolicyDefinition.h`) into the firmware codebase:

  ```
  cp AP_MotorsPolicyDefinition.h ../../Firmware/ardupilot/libraries/AP_Motors/
  ```

- Connect the Pixhawk 1.0 to your computer by usb cabel.

- Enter the folder `ArduCopter` by `cd Firmware/ardupilot/ArduCopter`.

- Compile and upload the firmware code by

  ```
  make px4-v2-upload
  ```


- Please refer to Ardupilot [official document](https://ardupilot.org/copter/index.html) for more detials.